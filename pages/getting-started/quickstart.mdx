---
name: PeopleFinder Quickstart
---

import { Playground } from 'dokz'

# PeopleFinder Quickstart

## Introduction

This guide will take you through the process of creating your first policy and using it from a 
demo application called PeopleFinder.

At the end of the process, you will have the following:
*   A free Aserto account
*   A free tenant associated with the account
*   A connection to your Source Code Control provider (in our examples, GitHub), so Aserto can help you create Policy bundles from policies stored in a policy repository
*   A connection to your Identity Provider (in our examples, Auth0), so that Aserto can sync your users into its directory
*   An Authorizer API key, which allows your application to talk to the Aserto hosted authorizer 
*   Our sample application, [PeopleFinder](github.com/aserto-demo/peoplefinder), cloned to your GitHub account
*   Your own copy of the policy repository associated with that sample application, [policy-peoplefinder](github.com/aserto-dev/policy-peoplefinder), in your GitHub account
*   A live version of PeopleFinder deployed to your Netlify account, which uses authorization policy that comes directly from your policy-peoplefinder policy repo
*   A CLI that allows you to manage the Aserto tenant and OneBox
*   A local developer experience (OneBox), which allows you to run a local copy of the authorizer in a docker container

Please allow about 30 minutes to have it all working end-to-end.

## 1: Creating your first policy

The underpinning of Aserto's authorization model is a [policy](policy-as-code). 

Policies are authored, stored, and versioned as code in a `git` repository.

### Add a policy 

![Add a policy](/add-a-policy.png)

When you click on “Add a policy”, select “GitHub” as your source code provider, and click the “Sign in & connect” button.

![sign in on github](/sign-in-github.png)

Once you complete GitHub’s OAuth2 consent flow, you'll be asked to select an organization & repo. Select the “New (using template)” radio button, and select the `policy-peoplefinder` template.

![create from template](/create-from-template.png)

Name your new repository something like `policy-peoplefinder`. Finally, name your policy with a descriptive name (e.g. peoplefinder). You’ll use this name later with the CLI.

![name policy](/name-policy.png)

Congratulations! You now have a clone of the `policy-peoplefinder` policy template in your GitHub account, hooked up to Aserto. Later, you’re going to modify this policy repository to change the authorization policy of the PeopleFinder application. But first, we want to connect to your Auth0 tenant and sync your users into the Aserto authorizer.

### Connect your Identity Provider

The PeopleFinder sample uses [Auth0](https://www.auth0.com) as its identity provider.  If you don't have 
an Auth0 account, create one now.  

**Auth0 machine-to-machine application**

Aserto needs to connect to an identity provider as the source of user attributes and roles. With Auth0, this means 
creating a machine-to-machine (M2M) application that is authorized to call the Auth0 management API. If you don't 
have an M2M application set up, create one now using the [Auth0 dashboard](https://manage.auth0.com/dashboard). 
It will look something like this:

![Auth0 M2M application](/auth0-m2m.png)

> Ensure that the M2M application is authorized to call the Auth0 management API:

![Auth0 M2M application](/auth0-m2m-mgmt.png)

> Ensure the scopes that are authorized include at least `read:users` so that Aserto can read your users.  

![Auth0 M2M scopes](/auth0-m2m-perms.png)

**Connect Aserto to your Auth0 tenant**

Now that you have an Auth0 M2M application, you're ready to connect Aserto to Auth0.

Click on the “Connections” Navbar tab to see your connections.

![connections](/connections.png)

Click on the “Connect” button for Auth0. You will be prompted to enter connection parameters:

![connect auth0](/connect-auth0.png)

Copy the Domain, Client ID, and Client Secret from the Auth0 UI into the Aserto UI.

### Set up test users for PeopleFinder

PeopleFinder expects to operate over users with extended attributes like `department, title, manager`.  In order to set things up correctly, you can load these user definitions into your Auth0 tenant using our CLI. Let’s install the Aserto CLI and load users into your tenant:

```bash
brew tap aserto-dev/tap && brew install aserto
aserto auth login
wget https://raw.githubusercontent.com/aserto-dev/aserto-cli/main/assets/acmecorp.json
aserto directory load-users --provider json --input acmecorp.json
```

### Exploring Users

Once you’ve connected your Auth0 tenant as an Identity Provider and loaded test users, you should be able to click the Users tab in the Navbar and see your users stream in using the Directory browser.

![users](/users.png)

## 2: Setting up the Auth0 Single-Page Application and API

### Create an Auth0 Single-Page Application

Create an Auth0 Single-Page Application called `PeopleFinder`, if you don’t have a SPA set up already that you would like to reuse.

Here is an example of what the Single Page Application needs to look like in the Auth0 management console:

![alt_text](images/image14.png "image_tooltip")

![alt_text](images/image15.png "image_tooltip")

> Note that the Application Type must be “Single Page Application” and all the URLs (callback URLs, logout URLs, Web Origins, and Origins should be set to 
`http://localhost:3000, https://*.netlify.app` (to cover both local development and the Netlify deployment).

### Create an Auth0 API

Create a new API with an Audience name of `express.sample`.

![alt_text](images/image16.png "image_tooltip")

Note: in the Auth0 UI, this will be labeled as “Identifier”.

![alt_text](images/image17.png "image_tooltip")

Congratulations! You now have everything you need for the Authentication portion of the PeopleFinder application. 

## 3: Getting PeopleFinder up and running against your tenant

### Deploy the PeopleFinder sample to Netlify

Bring up the [peoplefinder sample application repo](https://github.com/aserto-demo/peoplefinder) on GitHub, and scroll down to the Deployment section, which has a “Deploy to Netlify” button. Click this button to initiate the deployment to your Netlify account (if you don’t have one, you’ll be prompted to create one - it’s free and awesome!)

![alt_text](images/image18.png "image_tooltip")
 
You should see a screen like the following, which asks you to connect to your GitHub:

![alt_text](images/image19.png "image_tooltip")

Once you complete the OAuth2 flow and authorize Netlify, you’ll be able to configure your PeopleFinder Netlify site by copying the values from the PeopleFinder policy configuration screen:

![alt_text](images/image20.png "image_tooltip")

Replace the values for “Auth0 domain” and “Auth0 Client ID” with your Auth0 Single-Page Application information. **Important note:** make sure this is the SPA Client ID, not the Client ID for the Machine-to-Machine application we used in the first section.  Also, if you somehow used a value other than `https://express.sample` for your Auth0 API audience, make sure to match up the values in this form.

The last two pieces of information are your Aserto tenant ID and API key.

### Getting the Tenant ID and Authorizer API key for your tenant

Click the “Policies” tab, and click the `peoplefinder` Policy that you created in the first section. You’ll see the Policy configuration information for the peoplefinder policy.

![alt_text](images/image21.png "image_tooltip")

Copy Tenant ID, Authorizer API key, and Policy ID values and paste them into the Netlify form.

Netlify is now hard at work cloning the PeopleFinder sample repo into your GitHub account, and deploying a new site to your Netlify account, setting up a CI/CD experience for that site. 

### Testing the PeopleFinder application

When Netlify is done deploying your site, click on the deployed PeopleFinder URL to show the app hosted at `peoplefinder-xyz123.netlify.app.`  

![alt_text](images/image22.png "image_tooltip")

Click on the Login button and sign in with one of the users that are configured in your Auth0 account.  

The next few screens assume that you’ve seeded your Auth0 tenant with the sample users that we’ve set up for the PeopleFinder application.  These users have extended attributes, like `manager `and `department` which the PeopleFinder application relies on, and are used in the authorization policy. 

![alt_text](images/image23.png "image_tooltip")

Clicking on any of the users will show their information. Note that users can click the “Edit” button and edit their own information (like Name and Email), but can’t update other user’s information. If you click on Karen, try to change her name, and Save, you’ll get an error.

![alt_text](images/image24.png "image_tooltip")

Error for editing another user’s information looks like this. Note that if you log in as a user and try to change your own information, you’ll be able to do it.

![alt_text](images/image25.png "image_tooltip")

Also note that the “Update” button is disabled for users. This behavior is entirely defined and enforced by the authorization policy, which we will look at next.

## 4: Making a policy change and seeing it reflected in PeopleFinder

### Making a local clone of the policy repository

In the Policy configuration page, click on the “[https://github.com/[user]/policy-peoplefinder](https://github.com/[user]/peoplefinder-poicy)” link which opens a new browser window. 

![alt_text](images/image26.png "image_tooltip")

Copy the clone URL, open a terminal window, and do a `git clone` on the URL. Open a code editor window in that repository directory. You’ll see all the modules for the PeopleFinder policy.

The policy modules are organized by HTTP method and path. E.g. the` post.rego` file in the src/policies/__id directory has a package named `peoplefinder.POST.api.users.__id.`

This package controls access to the “Update” button at the bottom of a User card, and defines the policy that authorizes users to make changes to `department` and `title` attributes (see the code listing below).

![alt_text](images/image27.png "image_tooltip")

### Policy Change

Let’s make a change that will allow managers to update the `department` and `title` of their employees.

By default, the policy defined above only allows users in the “Operations” department to Update the extended user attributes, and only enables the button if the action is allowed.

If you change the line defining the `enabled `decision to default to `true `instead of `false`, the Update button will be enabled for all users.

![alt_text](images/image28.png "image_tooltip")

If you then add the following `allowed `block to the file, the policy will allow the operation if the logged-in user is the manager of the user they are trying to Update.

```
allowed {
   dir.is_manager_of(input.user.id, input.resource)
}
```

The final state of the Rego file should look like the code listing below:

![alt_text](images/image29.png "image_tooltip")

Now commit the changes, and create and push a new tag, so that the Aserto CI/CD workflow for policy changes kicks in, creates a new policy bundle based on the new tag, and makes it available to the authorizer:

```bash
git commit -am 'allow managers to update their employees'
git push 
git tag v0.0.1    # or whatever is the next tag number 
git push --tags
```

Check back to the console and ensure that the new policy is reflected in the Policy browser.

![alt_text](images/image30.png "image_tooltip")

When you see the new policy has been loaded by the authorizer, go back to PeopleFinder, reload, now the Update button is enabled, and a manager should be able to update their employee’s title.

To recap: we were able to change the authorization policy of the application without changing the application code, and without redeploying the application itself!

## 5. Installing a local authorizer running as a docker container

In Step 3 you installed the Aserto CLI.  You can use the same CLI to install and run a local authorizer on your desktop.

```
aserto dev install  # installs docker image
aserto dev configure --name peoplefinder # what you called the policy
aserto dev start --name peoplefinder # will use the peoplefinder policy
aserto dev console  # will show you what the local authorizer is running
aserto dev status   # displays the running status of the authorizer
aserto dev stop     # stops the authorizer
aserto dev update   # updates the authorizer image to latest
```

## Next Steps

Clone the PeopleFinder sample app repository in your GitHub account, and check out how the peoplefinder application uses the Aserto express SDK and React SDK to inject authorization into the application’s API, and conditionally render UI elements based on the “visible” and “enabled” attributes of the policy.